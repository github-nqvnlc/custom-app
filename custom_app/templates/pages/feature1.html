{% extends "templates/web.html" %}

{% block title %}{{ _("Customers") }}{% endblock %}

{% block page_content %}
<div class="container mt-5">
	<div class="row">
		<div class="col-12">
			<nav aria-label="breadcrumb">
				<ol class="breadcrumb">
					<li class="breadcrumb-item"><a href="/">Home</a></li>
					<li class="breadcrumb-item active" aria-current="page">Customers</li>
				</ol>
			</nav>

			<h1 class="mb-4">Customers</h1>

			<div class="row">
				<div class="col-md-5 mb-4">
					<div class="card">
						<div class="card-body">
							<h5 class="card-title">Add Customer</h5>
							<form id="customer-form">
								<div class="form-group">
									<label for="customer_name">Name <span class="text-danger">*</span></label>
									<input type="text" class="form-control" id="customer_name" required />
								</div>

								<div class="form-group">
									<label for="email">Email</label>
									<input type="email" class="form-control" id="email" />
								</div>

								<div class="form-group">
									<label for="phone">Phone</label>
									<input type="text" class="form-control" id="phone" />
								</div>

								<div class="form-group">
									<label for="role">Role</label>
									<select class="form-control" id="role">
										<option value="">-- Select --</option>
										<option value="Customer">Customer</option>
										<option value="VIP">VIP</option>
										<option value="Partner">Partner</option>
									</select>
								</div>

								<div class="form-group">
									<label for="address">Address</label>
									<textarea class="form-control" id="address" rows="3"></textarea>
								</div>

								<button type="submit" class="btn btn-primary">Save</button>
								<a href="/" class="btn btn-secondary ml-2">Back to Home</a>

								<div id="form-message" class="mt-3"></div>
							</form>
						</div>
					</div>
				</div>

				<div class="col-md-7 mb-4">
					<div class="card">
						<div class="card-body">
							<h5 class="card-title d-flex justify-content-between align-items-center">
								<span>Customer List</span>
							</h5>

							<div class="row mb-3">
								<div class="col-md-7">
									<input type="text" id="filter-search" class="form-control form-control-sm" placeholder="Search by name, email, phone, address..." />
								</div>
								<div class="col-md-5 mt-2 mt-md-0">
									<select id="filter-role" class="form-control form-control-sm">
										<option value="">All roles</option>
										<option value="Customer">Customer</option>
										<option value="VIP">VIP</option>
										<option value="Partner">Partner</option>
									</select>
								</div>
							</div>

							<div class="table-responsive">
								<table class="table table-striped" id="customers-table">
									<thead>
										<tr>
											<th>Name</th>
											<th>Email</th>
											<th>Phone</th>
											<th>Role</th>
											<th>Address</th>
											<th class="actions-header">Actions</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td colspan="6" class="text-muted text-center">Loading...</td>
										</tr>
									</tbody>
								</table>
								<div id="list-message" class="mt-2"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script>

// - Tạo mới Customer
// - Hiển thị danh sách Customer + Edit/Delete + Filter 
frappe.ready(function() {
	const tableBody = document.querySelector('#customers-table tbody'); 
	const form = document.getElementById('customer-form');
	const msg = document.getElementById('form-message'); 
	const listMsg = document.getElementById('list-message');
	const filterSearch = document.getElementById('filter-search');
	const filterRole = document.getElementById('filter-role'); 

	// Lưu toàn bộ danh sách customers lấy từ server để filter trên client
	let allCustomers = [];

	// Render các dòng trong bảng customers từ một mảng customers
	function renderRows(customers) {
		if (!customers || customers.length === 0) {
			tableBody.innerHTML = '<tr><td colspan="6" class="text-muted text-center">No customers yet.</td></tr>';
			return;
		}

		let html = '';
		customers.forEach(c => {
			html += `
				<tr>
					<td>${c.customer_name || ''}</td>
					<td>${c.email || ''}</td>
					<td>${c.phone || ''}</td>
					<td>${c.role || ''}</td>
					<td class="address-cell">${c.address || ''}</td>
					<td class="actions-cell">
						<button type="button" class="btn btn-sm btn-outline-primary btn-edit" data-name="${c.name}">Edit</button>
						<button type="button" class="btn btn-sm btn-outline-danger btn-delete ml-1" data-name="${c.name}">Delete</button>
					</td>
				</tr>
			`;
		});
		tableBody.innerHTML = html;

		attachRowEvents();
	}

	//searcg theo keyword và role, sau đó gọi hàm renderRows
	function applyFilters() {
		let filtered = allCustomers.slice();

		const keyword = (filterSearch.value || '').toLowerCase().trim();
		const role = (filterRole.value || '').trim();

		if (keyword) {
			filtered = filtered.filter(c => {
				const values = [
					c.customer_name,
					c.email,
					c.phone,
					c.address,
				].map(v => (v || '').toLowerCase());

				return values.some(v => v.includes(keyword));
			});
		}

		if (role) {
			filtered = filtered.filter(c => (c.role || '') === role);
		}

		renderRows(filtered);
	}

	// Gán event cho các button Edit/Delete sau khi chạy hàm renderRows
	function attachRowEvents() {
		const editButtons = document.querySelectorAll('#customers-table .btn-edit');
		const deleteButtons = document.querySelectorAll('#customers-table .btn-delete');

		editButtons.forEach(btn => {
			btn.addEventListener('click', function() {
				const name = this.getAttribute('data-name');
				if (!name) return;
				// edit customer
				window.location.href = '/feature1_edit?name=' + encodeURIComponent(name);
			});
		});

		deleteButtons.forEach(btn => {
			btn.addEventListener('click', function() {
				const name = this.getAttribute('data-name');
				if (!name) return;

				if (!confirm('Bạn có chắc chắn muốn xóa customer này không?')) {
					return;
				}

				listMsg.innerHTML = '<div class="alert alert-info">Deleting...</div>';

				frappe.call({
					method: 'custom_app.customdemo.doctype.customer.customer.delete_customer',
					args: { name },
					callback: function(r) {
						if (r.message && r.message.success) {
							listMsg.innerHTML = '<div class="alert alert-success">Deleted successfully.</div>';
							loadCustomers();
						} else {
							listMsg.innerHTML = '<div class="alert alert-danger">Failed to delete customer.</div>';
						}
					},
					error: function() {
						listMsg.innerHTML = '<div class="alert alert-danger">Error while deleting customer.</div>';
					}
				});
			});
		});
	}

	// Gọi API backend để lấy danh sách Customer mới nhất
	function loadCustomers() {
		frappe.call({
			method: 'custom_app.customdemo.doctype.customer.customer.get_customers',
			callback: function(r) {
				if (r.message) {
					allCustomers = r.message || [];
					applyFilters();
				}
			}
		});
	}

	// event submit form tạo mới Customer
	form.addEventListener('submit', function(e) {
		e.preventDefault();
		msg.innerHTML = '';

		const customer_name = document.getElementById('customer_name').value.trim();
		if (!customer_name) {
			msg.innerHTML = '<div class="alert alert-danger">Name is required.</div>';
			return;
		}

		const payload = {
			customer_name,
			email: document.getElementById('email').value.trim(),
			phone: document.getElementById('phone').value.trim(),
			role: document.getElementById('role').value,
			address: document.getElementById('address').value.trim(),
		};

		msg.innerHTML = '<div class="alert alert-info">Saving...</div>';

		frappe.call({
			method: 'custom_app.customdemo.doctype.customer.customer.create_customer',
			args: payload,
			callback: function(r) {
				if (r.message && r.message.success) {
					msg.innerHTML = '<div class="alert alert-success">Saved successfully!</div>';
					form.reset();
					loadCustomers();
				} else {
					msg.innerHTML = '<div class="alert alert-danger">Error saving customer.</div>';
				}
			}
		});
	});

	// Filter
	if (filterSearch) {
		filterSearch.addEventListener('input', function() {
			applyFilters();
		});
	}

	if (filterRole) {
		filterRole.addEventListener('change', function() {
			applyFilters();
		});
	}

	loadCustomers();
});
</script>

<style>
.card {
	border: none;
	box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card-title {
	margin-bottom: 1rem;
}

#customers-table {
	width: 100%;
	table-layout: auto;
}

#customers-table th,
#customers-table td {
	vertical-align: middle;
	white-space: nowrap;
}

#customers-table .address-cell {
	max-width: 160px;
	white-space: nowrap;
	overflow: hidden;
	text-overflow: ellipsis;
}

#customers-table .actions-header {
	width: 1%;
	white-space: nowrap;
}

#customers-table .actions-cell {
	white-space: nowrap;
}
</style>
{% endblock %}
