{% extends "templates/web.html" %}

{% block title %}{{ _("Customers") }}{% endblock %}

{% block page_content %}
<div class="container mt-5">
	<div class="row">
		<div class="col-12">
			<nav aria-label="breadcrumb">
				<ol class="breadcrumb">
					<li class="breadcrumb-item"><a href="/">Home</a></li>
					<li class="breadcrumb-item active" aria-current="page">Customers</li>
				</ol>
			</nav>

			<h1 class="mb-4">Customers</h1>

			<div class="row">
				<div class="col-md-5 mb-4">
					<div class="card">
						<div class="card-body">
							<h5 class="card-title">Add Customer</h5>
							<form id="customer-form">
								<div class="form-group">
									<label for="customer_name">Name <span class="text-danger">*</span></label>
									<input type="text" class="form-control" id="customer_name" required />
								</div>

								<div class="form-group">
									<label for="email">Email</label>
									<input type="email" class="form-control" id="email" />
								</div>

								<div class="form-group">
									<label for="phone">Phone</label>
									<input type="text" class="form-control" id="phone" />
								</div>

								<div class="form-group">
									<label for="role">Role</label>
									<select class="form-control" id="role">
										<option value="">-- Select --</option>
										<option value="Customer">Customer</option>
										<option value="VIP">VIP</option>
										<option value="Partner">Partner</option>
									</select>
								</div>

								<div class="form-group">
									<label for="address">Address</label>
									<textarea class="form-control" id="address" rows="3"></textarea>
								</div>

								<button type="submit" class="btn btn-primary">Save</button>
								<a href="/" class="btn btn-secondary ml-2">Back to Home</a>

								<div id="form-message" class="mt-3"></div>
							</form>
						</div>
					</div>
				</div>

				<div class="col-md-7 mb-4">
					<div class="card">
						<div class="card-body">
							<h5 class="card-title">Customer List</h5>
							<div class="table-responsive">
								<table class="table table-striped" id="customers-table">
									<thead>
										<tr>
											<th>Name</th>
											<th>Email</th>
											<th>Phone</th>
											<th>Role</th>
											<th>Address</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td colspan="5" class="text-muted text-center">Loading...</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
frappe.ready(function() {
	const tableBody = document.querySelector('#customers-table tbody');
	const form = document.getElementById('customer-form');
	const msg = document.getElementById('form-message');

	function renderRows(customers) {
		if (!customers || customers.length === 0) {
			tableBody.innerHTML = '<tr><td colspan="5" class="text-muted text-center">No customers yet.</td></tr>';
			return;
		}

		let html = '';
		customers.forEach(c => {
			html += `
				<tr>
					<td>${c.customer_name || ''}</td>
					<td>${c.email || ''}</td>
					<td>${c.phone || ''}</td>
					<td>${c.role || ''}</td>
					<td>${c.address || ''}</td>
				</tr>
			`;
		});
		tableBody.innerHTML = html;
	}

	function loadCustomers() {
		frappe.call({
			method: 'custom_app.customdemo.doctype.customer.customer.get_customers',
			callback: function(r) {
				if (r.message) {
					renderRows(r.message);
				}
			}
		});
	}

	form.addEventListener('submit', function(e) {
		e.preventDefault();
		msg.innerHTML = '';

		const customer_name = document.getElementById('customer_name').value.trim();
		if (!customer_name) {
			msg.innerHTML = '<div class="alert alert-danger">Name is required.</div>';
			return;
		}

		const payload = {
			customer_name,
			email: document.getElementById('email').value.trim(),
			phone: document.getElementById('phone').value.trim(),
			role: document.getElementById('role').value,
			address: document.getElementById('address').value.trim(),
		};

		msg.innerHTML = '<div class="alert alert-info">Saving...</div>';

		frappe.call({
			method: 'custom_app.customdemo.doctype.customer.customer.create_customer',
			args: payload,
			callback: function(r) {
				if (r.message && r.message.success) {
					msg.innerHTML = '<div class="alert alert-success">Saved successfully!</div>';
					form.reset();
					loadCustomers();
				} else {
					msg.innerHTML = '<div class="alert alert-danger">Error saving customer.</div>';
				}
			}
		});
	});

	loadCustomers();
});
</script>

<style>
.card {
	border: none;
	box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card-title {
	margin-bottom: 1rem;
}
</style>
{% endblock %}
