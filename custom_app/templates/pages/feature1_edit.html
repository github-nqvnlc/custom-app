{% extends "templates/web.html" %}

{% block title %}{{ _("Edit Customer") }}{% endblock %}

{% block page_content %}
<div class="container mt-5">
	<div class="row">
		<div class="col-12">
			<nav aria-label="breadcrumb">
				<ol class="breadcrumb">
					<li class="breadcrumb-item"><a href="/">Home</a></li>
					<li class="breadcrumb-item"><a href="/feature1">Customers</a></li>
					<li class="breadcrumb-item active" aria-current="page">Edit Customer</li>
				</ol>
			</nav>

			<h1 class="mb-4">Edit Customer</h1>

			<div class="row">
				<div class="col-md-6 mb-4">
					<div class="card">
						<div class="card-body">
							<h5 class="card-title">Customer Information</h5>
							<form id="edit-customer-form">
								<input type="hidden" id="docname" />

								<div class="form-group">
									<label for="customer_name">Name <span class="text-danger">*</span></label>
									<input type="text" class="form-control" id="customer_name" required />
								</div>

								<div class="form-group">
									<label for="email">Email</label>
									<input type="email" class="form-control" id="email" />
								</div>

								<div class="form-group">
									<label for="phone">Phone</label>
									<input type="text" class="form-control" id="phone" />
								</div>

								<div class="form-group">
									<label for="role">Role</label>
									<select class="form-control" id="role">
										<option value="">-- Select --</option>
										<option value="Customer">Customer</option>
										<option value="VIP">VIP</option>
										<option value="Partner">Partner</option>
									</select>
								</div>

								<div class="form-group">
									<label for="address">Address</label>
									<textarea class="form-control" id="address" rows="3"></textarea>
								</div>

								<button type="submit" class="btn btn-primary">Update</button>
								<a href="/feature1" class="btn btn-secondary ml-2">Back to Customer List</a>

								<div id="edit-form-message" class="mt-3"></div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
//Edit Customer (feature1_edit):
// - Đọc docname từ query (?name=...)
// - Gọi API get_customer để load dữ liệu vào form
// - Gọi API update_customer để cập nhật và quay lại trang danh sách
frappe.ready(function() {
	const form = document.getElementById('edit-customer-form'); // form edit
	const msg = document.getElementById('edit-form-message'); // vùng hiển thị message

	// Lấy giá trị 1 query param trong URL 
	function getQueryParam(name) {
		const params = new URLSearchParams(window.location.search);
		return params.get(name);
	}

	// Lấy docname Customer từ query string
	const docname = getQueryParam('name');
	if (!docname) {
		// Không có docname -> quay lại list
		window.location.href = '/feature1';
		return;
	}

	// Lưu docname vào input hidden để dùng khi submit
	document.getElementById('docname').value = docname;
	msg.innerHTML = '<div class="alert alert-info">Loading customer...</div>';

	// Load dữ liệu customer hiện tại từ backend
	frappe.call({
		method: 'custom_app.customdemo.doctype.customer.customer.get_customer',
		args: { name: docname },
		callback: function(r) {
			if (!r.message) {
				msg.innerHTML = '<div class="alert alert-danger">Customer not found.</div>';
				return;
			}

			const c = r.message;
			// Gán dữ liệu lên form
			document.getElementById('customer_name').value = c.customer_name || '';
			document.getElementById('email').value = c.email || '';
			document.getElementById('phone').value = c.phone || '';
			document.getElementById('role').value = c.role || '';
			document.getElementById('address').value = c.address || '';

			msg.innerHTML = '';
		},
		error: function() {
			msg.innerHTML = '<div class="alert alert-danger">Error loading customer.</div>';
		}
	});

	// Xử lý submit form Update
	form.addEventListener('submit', function(e) {
		e.preventDefault();
		msg.innerHTML = '';

		const customer_name = document.getElementById('customer_name').value.trim();
		if (!customer_name) {
			msg.innerHTML = '<div class="alert alert-danger">Name is required.</div>';
			return;
		}

		// Payload gửi lên backend để update
		const payload = {
			name: document.getElementById('docname').value,
			customer_name,
			email: document.getElementById('email').value.trim(),
			phone: document.getElementById('phone').value.trim(),
			role: document.getElementById('role').value,
			address: document.getElementById('address').value.trim(),
		};

		msg.innerHTML = '<div class="alert alert-info">Updating...</div>';

		frappe.call({
			method: 'custom_app.customdemo.doctype.customer.customer.update_customer',
			args: payload,
			callback: function(r) {
				if (r.message && r.message.success) {
					msg.innerHTML = '<div class="alert alert-success">Updated successfully! Redirecting...</div>';
					// Sau khi update thành công, quay lại trang danh sách
					setTimeout(function() {
						window.location.href = '/feature1';
					}, 1000);
				} else {
					msg.innerHTML = '<div class="alert alert-danger">Error updating customer.</div>';
				}
			},
			error: function() {
				msg.innerHTML = '<div class="alert alert-danger">Error updating customer.</div>';
			}
		});
	});
});
</script>

<style>
.card {
	border: none;
	box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card-title {
	margin-bottom: 1rem;
}
</style>
{% endblock %}


